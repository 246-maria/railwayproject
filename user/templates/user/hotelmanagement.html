{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="icon" href="{% static 'favicon.ico' %}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Management</title>
    <style>
        body {
            font-family: 'Times New Roman', Times, serif;
            background-image: url("{% static 'images/WhatsApp Image 2025-04-11 at 11.36.08_8ccf0fac.jpg' %}");
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            width: 100%;
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .heading-container {
            display: flex;
            align-items: center;
            border-bottom: 2px solid green;
            margin-bottom: 20px;
            padding-bottom: 10px;
        }

        .heading-container h2 {
            color: darkgreen;
            margin: 0;
        }

        .logo {
            width: 50px;
            height: auto;
            margin-right: 10px;
            padding-top: 3px;
        }

        a.button {
            background-color: darkgreen;
            color: #ffffff;
            padding: 0.5rem 1rem;
            text-decoration: none;
            border-radius: 0.375rem;
            font-weight: 600;
        }

        a.button:hover {
            background-color: green;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem 1rem;
            text-align: left;
        }

        th {
            background-color: darkgreen;
            color: white;
        }

        .row-even {
            background-color: rgb(188, 226, 188);
        }

        .row-odd {
            background-color: white;
        }

        button {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            border: none;
            color: #ffffff;
            cursor: pointer;
            font-size: 0.875rem;
        }

        button.update {
            background-color: darkgreen;
        }

        button.update:hover {
            background-color: green;
        }

        button.delete {
            background-color: #ef4444;
        }

        button.delete:hover {
            background-color: #dc2626;
        }

        form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        form input,
        form textarea,
        form select {
            display: block;
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }

        /* Highlight invalid inputs */
        input:invalid:not(:placeholder-shown),
        textarea:invalid:not(:placeholder-shown) {
            border-color: black;
        }

        .message-success {
            background-color: #4dca1c;
            color: #ffffff;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            transition: opacity 0.5s ease-out;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }

        .message-error {
            background-color: #fee2e2;
            color: #991b1b;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            transition: opacity 0.5s ease-out;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }

        .hidden {
            display: none;
        }

        .flex-space {
            display: flex;
            gap: 1rem;
        }

        h3 {
            font-size: 1.5rem;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="heading-container">
            <img src="{% static 'images/logo.jpg' %}" alt="My Logo" class="logo" />
            <h2>Hotel Management</h2>
        </div>
        {% if messages %}
        {% for message in messages %}
        <div
            class="{% if message.tags == 'success' %}message-success{% elif message.tags == 'error' %}message-error{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
        {% endif %}
        <a href="{% url 'manage_services' %}" class="button">Back to Main</a>
        <h4>Hotel List</h4>
        <div style="overflow-x:auto; margin-bottom:2rem;">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Hotel Name</th>
                        <th>Contact</th>
                        <th>Location</th>
                        <th>Rent/night</th>
                        <th>Rooms</th>
                        <th>Availability Date</th>
                        <th>Facilities</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for hotel in hotels %}
                    <tr class="{% if forloop.counter|divisibleby:2 %}row-even{% else %}row-odd{% endif %}">
                        <td>{{ hotel.pk }}</td>
                        <td>{{ hotel.hotel_name }}</td>
                        <td>{{ hotel.contact_number }}</td>
                        <td>{{ hotel.location }}</td>
                        <td>{{ hotel.room_rent }}</td>
                        <td>{{ hotel.available_rooms }} / {{ hotel.total_rooms }}</td>
                        <td>{{ hotel.booking_date|date:"Y-m-d" }}</td>
                        <td>{{ hotel.facilities }}</td>
                        <td>
                            <button onclick="showUpdateForm('{{ hotel.pk }}')" class="update">Update</button>
                            <form method="post" action="{% url 'hotel_management' %}" style="display:inline;"
                                onsubmit="return confirm('Are you sure you want to delete this hotel?');">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="delete">
                                <input type="hidden" name="hotel_id" value="{{ hotel.pk }}">
                                <button type="submit" class="delete">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div id="add-form-section">
            <h3>Add New Hotel</h3>
            <form method="post" action="{% url 'hotel_management' %}" onsubmit="return validateRooms(this);">
                {% csrf_token %}
                <input type="hidden" name="action" value="add">
                <label>Hotel Name:</label>
                <input type="text" name="hotel_name" id="add-hotel_name" required maxlength="50" pattern="[A-Za-z\s]+"
                    title="Hotel Name must contain only letters and spaces." oninput="validateLetters(this)">
                <label>Contact Number:</label>
                <input type="text" name="contact_number" id="add-contact_number" required maxlength="11"
                    pattern="[0-9]{11}" title="Contact must be exactly 11 digits (e.g., 03331234567)."
                    oninput="validateDigits(this)">
                <label>Location:</label>
                <input type="text" name="location" id="add-location" required maxlength="50" pattern="[A-Za-z\s]+"
                    title="Location must contain only letters and spaces." oninput="validateLetters(this)">
                <label>Room Rent (per night):</label>
                <input type="number" step="1" name="room_rent" id="add-room_rent" required min="1500" max="8000"
                    title="Rent must be a number between 1500 and 8000 PKR." oninput="validateRoomRent(this, 8000)">
                <label>Available Rooms:</label>
                <input type="number" name="available_rooms" id="add-available_rooms" required min="0" max="30"
                    title="Available Rooms must be a non-negative number, maximum 30." oninput="validateInteger(this)">
                <label>Total Rooms:</label>
                <input type="number" name="total_rooms" id="add-total_rooms" required min="1" max="30"
                    title="Total Rooms must be at least 1, maximum 30." oninput="validateInteger(this)">
                <label>Facilities:</label>
                <textarea name="facilities" id="add-facilities" required maxlength="3"
                    title="Facilities can only be 'abc'." oninput="validateFacilities(this)"></textarea>
                <label>Availability Date:</label>
                <input type="date" id="add-booking-date" name="booking_date" required>
                <button type="submit"
                    style="width:100%; background-color:darkgreen; color:white; padding:0.5rem; border-radius:0.375rem;">Add
                    Hotel</button>
            </form>
        </div>
        {% for hotel in hotels %}
        <div id="update-form-{{ hotel.pk }}" class="hidden">
            <h3>Update Hotel (ID: {{ hotel.pk }})</h3>
            <form method="post" action="{% url 'hotel_management' %}" onsubmit="return validateRooms(this);">
                {% csrf_token %}
                <input type="hidden" name="action" value="update">
                <input type="hidden" name="hotel_id" value="{{ hotel.pk }}">
                <label>Hotel Name:</label>
                <input type="text" name="hotel_name" value="{{ hotel.hotel_name }}" required maxlength="50"
                    pattern="[A-Za-z\s]+" title="Hotel Name must contain only letters and spaces."
                    oninput="validateLetters(this)">
                <label>Contact Number:</label>
                <input type="text" name="contact_number" value="{{ hotel.contact_number }}" required maxlength="11"
                    pattern="[0-9]{11}" title="Contact must be exactly 11 digits (e.g., 03331234567)."
                    oninput="validateDigits(this)">
                <label>Location:</label>
                <input type="text" name="location" value="{{ hotel.location }}" required maxlength="50"
                    pattern="[A-Za-z\s]+" title="Location must contain only letters and spaces."
                    oninput="validateLetters(this)">
                <label>Room Rent (per night):</label>
                <input type="number" step="1" name="room_rent" value="{{ hotel.room_rent }}" required min="1500"
                    max="8000" title="Rent must be a number between 1500 and 8000 PKR."
                    oninput="validateRoomRent(this, 8000)">
                <label>Available Rooms:</label>
                <input type="number" name="available_rooms" id="update-available_rooms-{{ hotel.pk }}"
                    value="{{ hotel.available_rooms }}" required min="0" max="30"
                    title="Available Rooms must be a non-negative number, maximum 30." oninput="validateInteger(this)">
                <label>Total Rooms:</label>
                <input type="number" name="total_rooms" id="update-total_rooms-{{ hotel.pk }}"
                    value="{{ hotel.total_rooms }}" required min="1" max="30"
                    title="Total Rooms must be at least 1, maximum 30." oninput="validateInteger(this)">
                <label>Facilities:</label>
                <textarea name="facilities" id="update-facilities-{{ hotel.pk }}" required maxlength="3"
                    title="Facilities can only be 'abc'.">{{ hotel.facilities }}</textarea>
                <label>Availability Date:</label>
                <input type="date" id="update-booking-date-{{ hotel.pk }}" name="booking_date"
                    value="{{ hotel.booking_date|date:'Y-m-d' }}" required>
                <div class="flex-space">
                    <button type="submit" style="flex:1; background-color:darkgreen; color: white;">Update
                        Hotel</button>
                </div>
            </form>
            <button onclick="hideUpdateForm('{{ hotel.pk }}')"
                style="width:100%; background-color:#ef4444; color:white; padding:0.5rem; border-radius:0.375rem; margin-top: 10px;">Cancel
                Update</button>
        </div>
        {% endfor %}
    </div>

    <script>
        function validateLetters(input) {
            input.value = input.value.replace(/[^A-Za-z\s]/g, '');
        }
        function validateDigits(input) {
            input.value = input.value.replace(/[^0-9]/g, '');
            if (input.value.length !== 11 && input.value.length > 0) {
                input.setCustomValidity('Contact must be exactly 11 digits (e.g., 03331234567).');
            } else {
                input.setCustomValidity('');
            }
        }

        function validateInteger(input) {
            input.value = input.value.replace(/[^0-9]/g, '');

            const min = parseInt(input.min);
            const max = parseInt(input.max); 
            let value = parseInt(input.value);

            if (input.value === '') {
                input.setCustomValidity("");
                return;
            }

            if (value > max) {
                input.value = max;
                value = max;
                input.setCustomValidity(input.title);
                setTimeout(() => {
                    input.setCustomValidity('');
                }, 500);

            } else if (value < min) {
                input.setCustomValidity(input.title);
            } else {
                input.setCustomValidity('');
            }
        }

        function validateRoomRent(input, maxLimit = 8000) {
            const minValue = 1500;
            const maxValue = 8000;
            let currentValue = parseInt(input.value);

            input.setCustomValidity('');

            if (input.value === '') {
                return;
            }

            if (currentValue > maxValue) {
                input.value = maxValue;
                currentValue = maxValue;
            }

            if (currentValue < minValue) {
                input.setCustomValidity(`Room Rent must be at least ${minValue} PKR.`);
            }
            else if (currentValue > maxValue) {
                input.setCustomValidity(`Room Rent cannot exceed ${maxValue} PKR.`);
            }
            else if (currentValue % 1 !== 0) {
                input.setCustomValidity("Room Rent must be a whole number.");
            }
            else {
                input.setCustomValidity('');
            }
        }
        function validateFacilities(input) {
            const allowedValue = 'abc';
            let filteredValue = input.value.replace(/[^abc]/gi, '');
          
            if (filteredValue.length > 3) {
                filteredValue = filteredValue.substring(0, 3);
            }
            input.value = filteredValue;

            const currentValue = input.value.trim().toLowerCase();
            input.setCustomValidity('');
            if (currentValue.length > 0 && currentValue !== allowedValue) {
                input.setCustomValidity(`Facilities can only be 'abc'.`);
            }
        }
        function validateRooms(form) {
            const availableRoomsInput = form.querySelector('[name="available_rooms"]');
            const totalRoomsInput = form.querySelector('[name="total_rooms"]');

            const available = parseInt(availableRoomsInput.value);
            const total = parseInt(totalRoomsInput.value);

            validateInteger(availableRoomsInput);
            validateInteger(totalRoomsInput);

            if (availableRoomsInput.checkValidity() === false || totalRoomsInput.checkValidity() === false) {
                availableRoomsInput.reportValidity(); 
                return false;
            }

            if (available > total) {
                availableRoomsInput.setCustomValidity('Available Rooms cannot be more than Total Rooms.');
                alert('Error: Available Rooms cannot be more than Total Rooms.');
                return false;
            } else {
                availableRoomsInput.setCustomValidity('');
                return true;
            }
        }

        function showUpdateForm(hotelId) {
            document.getElementById('add-form-section').classList.add('hidden');
            document.querySelectorAll('[id^="update-form-"]').forEach(form => {
                form.classList.add('hidden');
            });
            const updateForm = document.getElementById('update-form-' + hotelId);
            if (updateForm) {
                updateForm.classList.remove('hidden');
            }
        }
        function hideUpdateForm(hotelId) {
            const updateForm = document.getElementById('update-form-' + hotelId);
            if (updateForm) {
                updateForm.classList.add('hidden');
            }
            document.getElementById('add-form-section').classList.remove('hidden');
        }

        document.addEventListener('DOMContentLoaded', function () {
        
            const messages = document.querySelectorAll('.message-success, .message-error');
            messages.forEach(message => {
                setTimeout(() => {
                    message.style.opacity = '0';
                    setTimeout(() => {
                        message.style.display = 'none';
                    }, 500);
                }, 3000);
            });

            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const minDate = `${yyyy}-${mm}-${dd}`;

            const maxDateObj = new Date();
            maxDateObj.setMonth(maxDateObj.getMonth() + 2);
            const maxYYYY = maxDateObj.getFullYear();
            const maxMM = String(maxDateObj.getMonth() + 1).padStart(2, '0');
            const maxDD = String(maxDateObj.getDate()).padStart(2, '0');
            const maxDate = `${maxYYYY}-${maxMM}-${maxDD}`;

            const addDateInput = document.getElementById('add-booking-date');
            if (addDateInput) {
                addDateInput.setAttribute('min', minDate);
                addDateInput.setAttribute('max', maxDate);
            }

            document.querySelectorAll('[id^="update-booking-date-"]').forEach(input => {
                input.setAttribute('min', minDate);
                input.setAttribute('max', maxDate);

                input.addEventListener('change', function () {
                    if (this.value < minDate || this.value > maxDate) {
                        this.setCustomValidity(`Date must be between ${minDate} and ${maxDate}.`);
                    } else {
                        this.setCustomValidity('');
                    }
                });
            });

            document.querySelectorAll('[name="facilities"]').forEach(input => {
                input.addEventListener('input', function () {
                    validateFacilities(this);
                });
            });

            document.querySelectorAll('[name="room_rent"]').forEach(input => {
                input.addEventListener('input', function () {
                
                    validateRoomRent(this, 8000);
                });
            });

            document.querySelectorAll('[name="available_rooms"], [name="total_rooms"]').forEach(input => {
                input.addEventListener('input', function () {
                    validateInteger(this); 
                });
            });

            document.querySelectorAll('form').forEach(form => {
                form.addEventListener('submit', function (e) {
                    let valid = true;

                    
                    if (this.querySelector('[name="total_rooms"]')) {
                       
                        if (!validateRooms(this)) {
                            valid = false;
                        }
                    }

                    
                    const facilitiesInput = this.querySelector('[name="facilities"]');
                    if (facilitiesInput) {
                        validateFacilities(facilitiesInput);
                        if (facilitiesInput.checkValidity() === false) {
                            facilitiesInput.reportValidity();
                            valid = false;
                        }
                    }

                 
                    const rentInput = this.querySelector('[name="room_rent"]');
                    if (rentInput) {
                        validateRoomRent(rentInput, 8000);
                        if (rentInput.checkValidity() === false) {
                            rentInput.reportValidity();
                            valid = false;
                        }
                    }

                    if (!valid) {
                        e.preventDefault();
                    }
                });
            });
        });
    </script>
</body>

</html>