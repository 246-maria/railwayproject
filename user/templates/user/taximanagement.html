{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="icon" href="{% static 'favicon.ico' %}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Taxis</title>
    <style>
        body {
            font-family: 'Times New Roman', Times, serif;
            background-image: url("{% static 'images/WhatsApp Image 2025-04-11 at 11.36.08_8ccf0fac.jpg' %}");
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            background-color: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 1250px;
            width: 100%;
            text-align: center;
        }

        h2 {
            text-align: left;
            color: green;
            border-bottom: 2px solid green;
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: left;
            align-items: center;
            gap: 10px;
        }

        h3 {
            text-align: left;
            color: black;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .btn-group {
            margin-top: 20px;
            max-width: 100%;
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .btn {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
        }

        .btn-primary {
            background-color: green;
            color: white;
        }

        .btn-primary:hover {
            background-color: rgb(20, 146, 20);
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table,
        th,
        td {
            border: 1px solid #ddd;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: darkgreen;
            color: white;
        }

        tbody tr:nth-child(even) {
            background-color: rgb(188, 226, 188);
        }

        tbody tr:nth-child(odd) {
            background-color: white;
        }

        a.button {
            background-color: darkgreen;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            border: none;
            color: #ffffff;
            cursor: pointer;
            font-size: 0.875rem;
        }

        a.button:hover {
            background-color: green;
        }

        .alert-success {
            background-color: #17c21f;
            color: #fafafa;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
            transition: opacity 0.5s ease;
        }

        .alert-error {
            background-color: #fee2e2;
            color: #991b1b;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
            transition: opacity 0.5s ease;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>
            <img src="{% static 'images/logo.jpg' %}" alt="My Logo"
                style="width: 50px; height: auto; margin-right: 10px; padding-top: 3px;" />
            Taxi Management
        </h2>

        {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
        {% endif %}

        <a href="{% url 'manage_services' %}" class="button">Back to Main</a>

        <h3>All Taxis</h3>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Driver Name</th>
                    <th>Contact</th>
                    <th>Taxi Number</th>
                    <th>Taxi Name</th>
                    <th>City</th>
                    <th>Travel Date</th>
                    <th>Travel Time</th>
                    <th>From</th>
                    <th>To</th>
                    <th>Fare</th>
                    <th>Status</th>
                    <th>Availability</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for taxi in taxis %}
                <tr>
                    <td>{{ taxi.pk }}</td>
                    <td>{{ taxi.driver_name }}</td>
                    <td>{{ taxi.driver_contact }}</td>
                    <td>{{ taxi.taxi_number }}</td>
                    <td>{{ taxi.taxi_name }}</td>
                    <td>{{ taxi.city }}</td>
                    <td>{{ taxi.travel_date|date:"Y-m-d" }}</td>
                    <td>{{ taxi.travel_time|time:"H:i" }}</td>
                    <td>{{ taxi.from_location }}</td>
                    <td>{{ taxi.to_location }}</td>
                    <td>{{ taxi.fare }}</td>
                    <td>{{ taxi.status }}</td>
                    <td>{{ taxi.availability }}</td>
                    <td>
                        <button class="btn btn-primary edit-taxi-btn" data-pk="{{ taxi.pk }}"
                            data-driver-name="{{ taxi.driver_name }}" data-driver-contact="{{ taxi.driver_contact }}"
                            data-taxi-number="{{ taxi.taxi_number }}" data-taxi-name="{{ taxi.taxi_name }}"
                            data-city="{{ taxi.city }}" data-from-location="{{ taxi.from_location }}"
                            data-to-location="{{ taxi.to_location }}" data-fare="{{ taxi.fare }}"
                            data-travel-date="{{ taxi.travel_date|date:'Y-m-d' }}"
                            data-travel-time="{{ taxi.travel_time|time:'H:i' }}"
                            data-availability="{{ taxi.availability }}" data-status="{{ taxi.status }}">Edit</button>
                        <form action="{% url 'taxi_management' %}" method="POST" style="display:inline;">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="delete">
                            <input type="hidden" name="taxi_id" value="{{ taxi.pk }}">
                            <button type="submit" class="btn btn-danger"
                                onclick="return confirm('Are you sure you want to delete this taxi?')">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h3>Add/Update Taxi</h3>
        <form action="{% url 'taxi_management' %}" method="POST" id="taxi-form">
            {% csrf_token %}
            <input type="hidden" name="action" id="form-action" value="add">
            <input type="hidden" name="taxi_id" id="taxi-id">

            <div class="form-group">
                <label for="driver_name">Driver Name</label>
                <input type="text" name="driver_name" id="driver_name" required maxlength="50" pattern="[A-Za-z\s]+"
                    title="Driver Name must contain only letters and spaces." oninput="validateLetters(this)">
            </div>
            <div class="form-group">
                <label for="driver_contact">Driver Contact</label>
                <input type="text" name="driver_contact" id="driver_contact" required maxlength="11" pattern="[0-9]{11}"
                    title="Contact must be exactly 11 digits (e.g., 03331234567)." oninput="validateDigits(this)">
            </div>
            <div class="form-group">
                <label for="taxi_number">Taxi Number</label>
                <input type="text" name="taxi_number" id="taxi_number" required maxlength="5"
                    pattern="[A-Za-z]{2}[0-9]{3}"
                    title="Taxi Number must be 2 letters followed by 3 digits (e.g., PK103)."
                    oninput="validateTaxiNumber(this)">
            </div>
            <div class="form-group">
                <label for="taxi_name">Taxi Name</label>
                <input type="text" name="taxi_name" id="taxi_name" required maxlength="50" pattern="[A-Za-z\s]+"
                    title="Taxi Name must contain only letters and spaces." oninput="validateLetters(this)">
            </div>
            <div class="form-group">
                <label for="city">City</label>
                <select name="city" id="city" required>
                    <option value="">--Select City--</option>
                    <option value="Karachi">Karachi</option>
                    <option value="Lahore">Lahore</option>
                    <option value="Islamabad">Islamabad</option>
                    <option value="Peshawar">Peshawar</option>
                    <option value="Quetta">Quetta</option>
                    <option value="Multan">Multan</option>
                    <option value="Faisalabad">Faisalabad</option>
                    <option value="Hyderabad">Hyderabad</option>
                    <option value="Gujranwala">Gujranwala</option>
                    <option value="Sialkot">Sialkot</option>
                    <option value="Rawalpindi">Rawalpindi</option>
                    <option value="Gujrat">Gujrat</option>
                    <option value="Bahawalpur">Bahawalpur</option>
                    <option value="Sukkur">Sukkur</option>
                    <option value="Sargodha">Sargodha</option>
                    <option value="Mardan">Mardan</option>
                    <option value="Abbottabad">Abbottabad</option>
                    <option value="Mirpur">Mirpur</option>
                    <option value="Muzaffarabad">Muzaffarabad</option>
                    <option value="Gawadar">Gawadar</option>
                </select>
            </div>

            <div class="form-group">
                <label for="from_location">From Location</label>
                <input type="text" name="from_location" id="from_location" required maxlength="50" pattern="[A-Za-z\s]+"
                    title="Location must contain only letters and spaces." oninput="validateLetters(this)">
            </div>
            <div class="form-group">
                <label for="to_location">To Location</label>
                <input type="text" name="to_location" id="to_location" required maxlength="50" pattern="[A-Za-z\s]+"
                    title="Location must contain only letters and spaces." oninput="validateLetters(this)">
            </div>
            <div class="form-group">
                <label for="travel_date">Travel Date</label>
                <input type="date" name="travel_date" id="travel_date" required>
            </div>
            <div class="form-group">
                <label for="travel_time">Travel Time</label>
                <input type="time" name="travel_time" id="travel_time" required>
            </div>
            <div class="form-group">
                <label for="fare">Total Fare (PKR)</label>
                <input type="number" step="1.00" name="fare" id="fare" required min="100" max="2000"
                    title="Fare must be a positive number, between 100 and 2000 PKR."
                    oninput="validatePositiveNumber(this)">
            </div>
            <div class="form-group">
                <label for="availability">Availability</label>
                <select name="availability" id="availability" required>
                    <option value="True">Available</option>
                    <option value="False">Not Available</option>
                </select>
            </div>
            <div class="form-group">
                <label for="status">Booking Status</label>
                <select name="status" id="status" required>
                    <option value="Available">Available</option>
                    <option value="Booked">Booked</option>
                </select>
            </div>

            <div class="btn-group">
                <button type="submit" class="btn btn-primary" id="submit-btn">Add Taxi</button>
            </div>
        </form>
    </div>

    <script>

        function validateLetters(input) {
            input.value = input.value.replace(/[^A-Za-z\s]/g, '');
        }

        function validateDigits(input) {
            input.value = input.value.replace(/[^0-9]/g, '');
        }

        function validateTaxiNumber(input) {
            const MAX_LENGTH = 5;
            const NUM_LETTERS = 2;
            let value = input.value;
            let cleanedValue = '';

            if (value.length > MAX_LENGTH) {
                value = value.substring(0, MAX_LENGTH);
            }

            for (let i = 0; i < Math.min(NUM_LETTERS, value.length); i++) {
                if (/[A-Za-z]/.test(value[i])) {
                    cleanedValue += value[i].toUpperCase();
                } else {
                    break;
                }
            }

            for (let i = NUM_LETTERS; i < Math.min(MAX_LENGTH, value.length); i++) {
                if (/[0-9]/.test(value[i])) {
                    cleanedValue += value[i];
                } else {
                    break;
                }
            }

            input.value = cleanedValue;
        }

        function validatePositiveNumber(input) {
            const maxValue = 2000;
            const minValue = 100; 
            const currentValue = parseFloat(input.value);

            if (input.value !== '' && currentValue <= 0) {
                input.setCustomValidity('Fare must be a positive value.');
                input.value = minValue;
                return;
            }

            if (input.value !== '' && currentValue < minValue) {
                input.setCustomValidity('Fare must be at least ' + minValue + ' PKR.');
                return;
            }

            if (currentValue > maxValue) {
                input.setCustomValidity('Fare cannot exceed ' + maxValue + ' PKR.');
                input.value = maxValue; 
            } else {
                input.setCustomValidity(''); 
            }
        }

        function editTaxi(id, driverName, contact, number, taxiName, city, fromLoc, toLoc, fare, travelDate, travelTime, availability, status) {
            document.getElementById('form-action').value = 'update';
            document.getElementById('taxi-id').value = id;
            document.getElementById('driver_name').value = driverName;
            document.getElementById('driver_contact').value = contact;
            document.getElementById('taxi_number').value = number;
            document.getElementById('taxi_name').value = taxiName;
            document.getElementById('city').value = city;
            document.getElementById('from_location').value = fromLoc;
            document.getElementById('to_location').value = toLoc;
            document.getElementById('fare').value = fare;
            document.getElementById('travel_date').value = travelDate;
            document.getElementById('travel_time').value = travelTime;
            document.getElementById('availability').value = availability === 'True' ? 'True' : 'False';
            document.getElementById('status').value = status;
            document.getElementById('submit-btn').innerText = 'Update Taxi';
        }

        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.edit-taxi-btn').forEach(button => {
                button.addEventListener('click', function () {
                    editTaxi(
                        this.dataset.pk,
                        this.dataset.driverName,
                        this.dataset.driverContact,
                        this.dataset.taxiNumber,
                        this.dataset.taxiName,
                        this.dataset.city,
                        this.dataset.fromLocation,
                        this.dataset.toLocation,
                        this.dataset.fare,
                        this.dataset.travelDate,
                        this.dataset.travelTime,
                        this.dataset.availability,
                        this.dataset.status
                    );
                });
            });

            const alerts = document.querySelectorAll('.alert-success, .alert-error');
            alerts.forEach(alert => {
                setTimeout(() => {
                    alert.style.opacity = '0';
                    setTimeout(() => {
                        alert.style.display = 'none';
                    }, 500);
                }, 3000);
            });

            const travelDateInput = document.getElementById('travel_date');
            const today = new Date();
            const minDate = today.toISOString().split('T')[0]; 

            const twoMonthsLater = new Date();
            twoMonthsLater.setMonth(today.getMonth() + 2);
            const maxDate = twoMonthsLater.toISOString().split('T')[0];

            if (travelDateInput) {
                travelDateInput.min = minDate;
                travelDateInput.max = maxDate;
            }

            document.getElementById('fare').addEventListener('input', function () {
                validatePositiveNumber(this);
            });
        });
    </script>
</body>

</html>